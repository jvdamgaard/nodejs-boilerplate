var fsExt = require('./fs-ext'),
    _     = require('underscore'),
    im    = require('imagemagick'),
    cache = require('./cache');

var setSprite = function(cssObj, name, pseudo) {

  var width     = Math.round(cssObj.width/2),
      height    = Math.round(cssObj.height/2),
      xOffset   = Math.round(cssObj.xOffset/2);

      name      = '"' + name + '"';

  if (pseudo) {
    pseudo    = '"' + pseudo + '"';
    return '#sprite > .pseudo-class(' + [name, pseudo, width, height, xOffset].join(',') + ');\n';
  } else {
    return '#sprite > .css-class(' + [name, width, height, xOffset].join(',') + ');\n';
  }
};

module.exports.generate = function(tree, image, lessFile, callback) {

  cache.add(image.retina, function(retinaUrl) {
    cache.add(image.nonRetina, function(nonRetinaUrl) {

      im.identify(image.nonRetina, function(err, features){
        if (err) return callback(err);

        var bgWidth      = features.width,
            bgHeight     = features.height;
            retinaUrl    = '"' + retinaUrl + '"';
            nonRetinaUrl = '"' + nonRetinaUrl + '"';

        var less = '// Autogenerated sprites\n\n';

        less += '#sprite > .init;\n';
        less += '#sprite > .set-background(' + nonRetinaUrl + ');\n';
        less += '#sprite > .set-retina-background(' + [retinaUrl, bgWidth, bgHeight].join(',') + ');\n';
        less += '\n';

        for (var cssClass in tree) {
          less += setSprite(tree[cssClass], cssClass);

          if (tree[cssClass][':active']) {
            tree[cssClass]['.active'] = tree[cssClass][':active'];
          }

          for (var pseudoClass in tree[cssClass]) {
            if (_.indexOf(pseudoClass, ':') === 0 || _.indexOf(pseudoClass, '.') === 0) {
              less += setSprite(tree[cssClass][pseudoClass], cssClass, pseudoClass);
            }
          }
          less += '\n';
        }

        fsExt.writeFile(lessFile, less, function(err) {
          callback(err);
        });
      });
    });
  });
};